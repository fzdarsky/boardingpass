#!/bin/sh
# Example password generator for BoardingPass SRP-6a authentication
#
# This script generates a device-unique password based on hardware identifiers.
# The password is used to compute the SRP verifier at runtime.
#
# Installation:
#   1. Copy this script to /usr/lib/boardingpass/password-generator
#   2. Make it executable: chmod 0500 /usr/lib/boardingpass/password-generator
#   3. Set ownership: chown root:boardingpass /usr/lib/boardingpass/password-generator
#   4. Reference it in /etc/boardingpass/verifier JSON file
#
# Security notes:
#   - This script runs as root (via boardingpass service)
#   - Output is the device-unique password (sensitive!)
#   - Script should be read-only for owner, no access for others
#   - Password should be printed on device label for operator access
#
# Example implementations:

# Option 1: Use board serial number from DMI
# Recommended for enterprise hardware with unique serial numbers
if [ -f /sys/class/dmi/id/board_serial ]; then
    SERIAL=$(cat /sys/class/dmi/id/board_serial)
    if [ -n "$SERIAL" ] && [ "$SERIAL" != "Not Specified" ]; then
        echo "$SERIAL"
        exit 0
    fi
fi

# Option 2: Use TPM endorsement key (if TPM is available)
# Recommended for devices with TPM 2.0
# Requires tpm2-tools package installed
if command -v tpm2_readpublic >/dev/null 2>&1; then
    TPM_EK=$(tpm2_readpublic -c 0x81010001 2>/dev/null | sha256sum | cut -d' ' -f1)
    if [ -n "$TPM_EK" ]; then
        echo "$TPM_EK"
        exit 0
    fi
fi

# Option 3: Use primary MAC address
# Fallback for devices without DMI or TPM
# Note: MAC addresses can be changed, less secure than serial/TPM
PRIMARY_MAC=$(ip link show | grep -A1 '^2:' | grep 'link/ether' | awk '{print $2}' | head -n1)
if [ -n "$PRIMARY_MAC" ]; then
    echo "$PRIMARY_MAC"
    exit 0
fi

# Option 4: Use combined hardware ID (most secure)
# Concatenate multiple identifiers and hash
# BOARD_SERIAL=$(cat /sys/class/dmi/id/board_serial 2>/dev/null || echo "")
# BOARD_UUID=$(cat /sys/class/dmi/id/product_uuid 2>/dev/null || echo "")
# CPU_SERIAL=$(cat /proc/cpuinfo | grep 'Serial' | head -n1 | awk '{print $3}' || echo "")
# COMBINED="${BOARD_SERIAL}${BOARD_UUID}${CPU_SERIAL}"
# echo "$COMBINED" | sha256sum | cut -d' ' -f1
# exit 0

# Fallback: error
echo "ERROR: Unable to generate device-unique password" >&2
exit 1
