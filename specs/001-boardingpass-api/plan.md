# Implementation Plan: BoardingPass API

**Branch**: `001-boardingpass-api` | **Date**: 2025-12-06 (updated after clarification session) | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/001-boardingpass-api/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command and covers both the BoardingPass service (Linux device) and the mobile app (iOS/Android), with initial focus on the service implementation. Updated 2025-12-06 to incorporate clarifications on session expiry (30min), brute force protection (progressive delays), TLS certificate generation (self-signed at boot), configuration path restrictions (allow-lists), and explicit completion endpoint (POST /complete).

## Summary

BoardingPass is a lightweight, ephemeral bootstrap service for headless Linux devices, exposing a RESTful API over HTTPS with SRP-6a authentication. Authentication uses device-unique passwords generated dynamically from hardware identifiers (serial number, TPM endorsement key, MAC address), eliminating the single-password-per-image problem while maintaining a unified bootc image. The service enables secure device inventory querying, atomic configuration provisioning via path-restricted bundles, and execution of allow-listed system commands. The operator explicitly signals provisioning completion via POST /complete, triggering sentinel file creation and graceful termination. Security features include progressive brute-force protection (1s/2s/5s/60s delays), 30-minute session token expiry, TLS 1.3 with self-signed certificates generated at boot, and configurable path allow-lists for configuration writes. A companion mobile app (iOS/Android) will provide a frictionless UX for bootstrap operators. The technical approach emphasizes minimal dependencies, static linking, and strict security controls to align with the BoardingPass constitution principles.

## Technical Context

**Language/Version**: Go 1.25 or higher from the `registry.access.redhat.com/ubi9/go-toolset` distribution (strict dependency diet: Standard Library preferred; minimal vetted external deps)

**Primary Dependencies**:
- **SRP-6a Implementation**: Go standard library `crypto/*` only (FIPS 140-3 compliance requirement - no third-party crypto libraries)
- **HTTP/TLS Server**: Go standard library `net/http` with TLS 1.3 enforcement
- **System Inspection**: Go standard library (`os`, `os/exec`, `net`) + `/sys` and `/proc` filesystem access
- **Logging**: Write to stdout/stderr (systemd journal captures automatically)
- **Configuration**: `gopkg.in/yaml.v3` (single minimal dep)
- **Testing**: Go standard library `testing` + `net/http/httptest`
- **Build/Release**: GoReleaser for build orchestration, cross-compilation, and packaging

**Mobile App (Future Phase)**:
- **Language/Framework**: TypeScript with React Native
- **Dependencies**: React Native core, React Navigation, Axios (HTTP client), minimal UI library
- **Testing**: Jest for unit tests, Detox for E2E testing

**Storage**:
- **Device Service**: Filesystem-based (no database required)
  - SRP config: `/etc/boardingpass/verifier` (JSON: username, salt, password_generator script path)
  - Password generator: User-configurable script (e.g., `/usr/lib/boardingpass/password-generator`) that outputs device-unique password from hardware identifiers (serial #, TPM EK, MAC address)
  - Verifier computation: Dynamic at runtime (compute `v = g^x % N` from generated password)
  - Service config: `/etc/boardingpass/config.yaml` (includes path allow-list for config writes)
  - Sentinel file: `/etc/boardingpass/issued` (empty file, presence indicates bootstrapped)
  - Temporary staging: `/var/lib/boardingpass/staging/` (ephemeral, cleared on success/failure)
  - TLS certificates: `/var/lib/boardingpass/tls/` (self-signed, generated at first boot if not in OS image)
  - Session tokens: In-memory map with 30-min TTL (no persistence)
  - Brute force tracking: In-memory map with progressive delay state per client IP
- **Mobile App**: Local storage for app preferences, no sensitive data persistence

**Testing**:
- **Device Service**:
  - Unit tests: Go standard library `testing` with table-driven tests
  - Integration tests: `httptest` for API endpoint testing, mock filesystem operations with standard library
  - Contract tests: OpenAPI spec validation against actual API responses
  - Linting & Security: `golangci-lint` version 2.7.1 with integrated `gosec` and `govulncheck` linters
  - E2E tests: Containerized test environment with systemd (Podman/Docker)
- **Mobile App**:
  - Unit tests: Jest with React Native Testing Library
  - Integration tests: Mock API server responses
  - E2E tests: Detox on iOS simulator / Android emulator

**Target Platform**:
- **Device Service**: Linux amd64 and arm64
  - RHEL 9+, Rocky Linux 9+, AlmaLinux 9+
  - Debian 12+, Ubuntu 22.04+ LTS
  - Container-based: `bootc` bootable container images
  - Systemd 250+ required
- **Mobile App**: iOS 15.0+, Android 10+ (API level 29+)

**Project Type**: Multi-component (Linux service + mobile app)

**Performance Goals**:
- SRP handshake: < 500ms on Raspberry Pi 4 or equivalent
- Device inventory query: < 100ms response time
- Network configuration query: < 100ms response time
- Configuration bundle application: < 5 seconds for 10MB bundle
- Service startup (with sentinel check): < 1 second
- Service shutdown (graceful termination): < 5 seconds

**Constraints**:
- Binary size: < 10MB (stripped, statically linked)
- Memory consumption: < 50MB RAM (idle), < 150MB (active configuration provisioning)
- No runtime dependencies beyond systemd and basic Linux utilities
- TLS 1.3 minimum (reject TLS 1.2 and below)
- TLS certificates: Self-signed generated at first boot if not provided in OS image
- Session token lifetime: 30 minutes (from clarification session 2025-12-06)
- Inactivity timeout: 10 minutes default (configurable, minimum 1 minute)
- Brute force protection: Progressive delays (1s, 2s, 5s, then 60s lockout) after failed auth attempts
- Configuration path restrictions: Allow-list of permitted subdirectories (configurable, e.g., `/etc/systemd/`, `/etc/myapp/`)

**Scale/Scope**:
- Single-device bootstrap (no multi-device orchestration)
- Single concurrent bootstrap operator (serialized configuration provisioning)
- Configuration bundle: Up to 10MB, up to 100 files
- Allow-list: Up to 50 commands
- Network interfaces: Up to 32 interfaces per device
- Session token storage: In-memory map for up to 10 concurrent sessions (defense against session exhaustion)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Frictionless Bootstrapping

- ✅ **Pass**: SRP-6a with device-unique passwords (generated from hardware identifiers) eliminates PKI setup complexity
- ✅ **Pass**: Password can be printed on device label (derived from serial #/TPM/MAC) and scanned by mobile app
- ✅ **Pass**: Single bootc image works for all devices (unique passwords generated at runtime)
- ✅ **Pass**: Mobile app (future) provides simple UX for bootstrap operators
- ✅ **Pass**: Service requires minimal configuration (single config file, reasonable defaults)
- ✅ **Pass**: Compatible with RHEL 9+ and bootc container images
- ✅ **Pass**: No display/keyboard required; operates via API over network transports

### II. Ephemeral & Fail-Safe Operation

- ✅ **Pass**: Sentinel file (`/etc/boardingpass/issued`) prevents service from running on provisioned devices
- ✅ **Pass**: Inactivity timeout ensures service self-terminates when idle
- ✅ **Pass**: Atomic configuration operations with rollback on failure
- ✅ **Pass**: No persistent daemon after bootstrap completion
- ✅ **Pass**: Fail-safe: All configuration operations are atomic (temp-write → validate → move)

### III. Minimal Footprint

- ✅ **Pass**: Binary size target < 10MB (static linking, stripped)
- ✅ **Pass**: Memory consumption < 50MB idle, < 150MB active
- ✅ **Pass**: No compilation required on target (pre-built binaries in RPM/DEB)
- ✅ **Pass**: Single-digit megabyte package size

### IV. Minimal Dependencies

- ✅ **Pass**: Go standard library preferred for most functionality
- ✅ **Pass**: SRP-6a implementation uses only Go crypto/* (FIPS 140-3 compliance)
- ✅ **Pass**: Logging to stdout/stderr (systemd captures automatically, no journald library dependencies)
- ✅ **Pass**: Systemd and basic Linux utilities only (no exotic dependencies)
- ✅ **Pass**: Static linking eliminates runtime library dependencies

### V. Transport Agnostic & Protocol First

- ✅ **Pass**: RESTful API with OpenAPI 3.1 spec acts as protocol contract
- ✅ **Pass**: Service configuration includes transport abstraction (initially Ethernet, future WiFi/BLE/USB)
- ✅ **Pass**: Mobile app (future) will consume OpenAPI spec for auto-generated client code
- ✅ **Pass**: Protocol (JSON over HTTPS) is transport-independent

### VI. Open Source & Permissive Licensing

- ✅ **Pass**: MIT or Apache 2.0 license planned
- ✅ **Pass**: All source code will be publicly accessible (GitHub)
- ✅ **Pass**: RPM/DEB packaging via GoReleaser included for distribution
- ✅ **Pass**: All dependencies (Go stdlib crypto, gopkg.in/yaml.v3) use permissive licenses

### Gate Evaluation

**Status**: ✅ **PASS** (all checks satisfied)

**Key Decisions**:
1. SRP-6a implementation: Go standard library crypto/* only (FIPS 140-3 compliance)
2. Dynamic password generation: User-configurable script generates device-unique passwords from hardware identifiers (solves single-password-per-image problem)
3. Build orchestration: GoReleaser for cross-compilation and packaging
4. Security tooling: golangci-lint with integrated gosec and govulncheck

**Re-evaluation Trigger**: After Phase 1 design completion, re-check compliance

## Project Structure

### Documentation (this feature)

```text
specs/001-boardingpass-api/
├── plan.md                     # This file (/speckit.plan command output)
├── research.md                 # Phase 0 output (technology decisions, library evaluation)
├── data-model.md               # Phase 1 output (entity definitions, JSON schemas)
├── quickstart.md               # Phase 1 output (local development setup guide)
├── contracts/                  # Phase 1 output (API specifications)
│   ├── openapi.yaml            # OpenAPI 3.1 specification
│   └── examples/               # Example requests/responses
│       ├── auth-srp-init.json
│       ├── auth-srp-verify.json
│       ├── info-response.json
│       ├── network-response.json
│       ├── configure-request.json
│       ├── command-request.json
│       └── complete-response.json
├── checklists/                 # Quality validation checklists
│   └── requirements.md         # Spec quality checklist (already created)
└── tasks.md                    # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
boardingpass/                   # Repository root
├── cmd/
│   └── boardingpass/           # Main service binary
│       └── main.go
├── internal/
│   ├── api/                    # HTTP handlers and routing
│   │   ├── middleware/         # Authentication, logging, error handling
│   │   ├── handlers/           # Endpoint handlers (auth, info, network, configure, command, complete)
│   │   └── server.go           # HTTP server setup and lifecycle
│   ├── auth/                   # SRP-6a authentication logic
│   │   ├── srp.go              # SRP protocol implementation / wrapper
│   │   ├── session.go          # Session token management (30-min expiry)
│   │   ├── ratelimit.go        # Brute force protection (progressive delays: 1s, 2s, 5s, 60s)
│   │   └── verifier.go         # Verifier file loading and validation
│   ├── tls/                    # TLS certificate management
│   │   ├── certgen.go          # Self-signed certificate generation
│   │   └── config.go           # TLS 1.3+ configuration
│   ├── inventory/              # Device inventory collection
│   │   ├── tpm.go              # TPM information extraction
│   │   ├── board.go            # Board/DMI information extraction
│   │   ├── cpu.go              # CPU architecture detection
│   │   ├── os.go               # OS distribution and version detection
│   │   └── fips.go             # FIPS mode status check
│   ├── network/                # Network configuration querying
│   │   ├── interfaces.go       # Interface enumeration
│   │   ├── linkstate.go        # Link state detection
│   │   └── addresses.go        # IP address extraction
│   ├── provisioning/           # Configuration bundle processing
│   │   ├── bundle.go           # Bundle validation and parsing
│   │   ├── pathvalidator.go    # Path allow-list validation (prevents writes to /etc/passwd, etc.)
│   │   ├── applier.go          # Atomic file application logic
│   │   └── rollback.go         # Rollback mechanism on failure
│   ├── command/                # Command execution
│   │   ├── allowlist.go        # Allow-list loading and validation
│   │   ├── executor.go         # Sudo command execution
│   │   └── sudoers.go          # Sudoers file validation
│   ├── lifecycle/              # Service lifecycle management
│   │   ├── sentinel.go         # Sentinel file checking and creation
│   │   ├── timeout.go          # Inactivity timeout tracking
│   │   └── shutdown.go         # Graceful shutdown handler
│   ├── config/                 # Configuration management
│   │   ├── config.go           # Configuration struct and loading (includes path allow-list)
│   │   └── validate.go         # Configuration validation
│   └── logging/                # Structured logging to stdout/stderr
│       ├── logger.go           # JSON logging to stdout/stderr (systemd captures)
│       └── redactor.go         # Secret redaction logic (auth tokens, config payloads)
├── pkg/                        # Public/reusable packages (future mobile app SDK)
│   └── protocol/               # Protocol definitions (shared with mobile app)
│       ├── types.go            # Shared data structures (SystemInfo, NetworkConfig, ConfigBundle)
│       └── errors.go           # Standardized error codes and messages
├── tests/
│   ├── unit/                   # Unit tests (parallel to internal/ structure)
│   ├── integration/            # Integration tests (API endpoint tests)
│   ├── contract/               # Contract tests (OpenAPI validation)
│   └── e2e/                    # End-to-end tests (systemd + full workflow)
├── build/
│   ├── Containerfile           # Podman build environment
│   ├── Dockerfile              # Docker build environment (alias to Containerfile)
│   ├── boardingpass.service    # Systemd unit file
│   ├── boardingpass.sudoers    # Sudoers configuration file
│   ├── password-generator.example  # Example password generator script
│   └── scripts/
│       └── install-hooks.sh    # Pre/post-install hooks for packages
├── _output/                    # Build artifacts (gitignored, created by GoReleaser/local builds)
│   ├── bin/                    # Compiled binaries (boardingpass)
│   ├── dist/                   # GoReleaser dist directory (RPM, DEB, archives)
│   └── coverage/               # Test coverage reports
├── .goreleaser.yaml            # GoReleaser configuration (outputs to _output/dist/)
├── .github/
│   └── workflows/
│       ├── service-ci.yaml     # CI/CD for Go service
│       ├── mobile-ci.yaml      # CI/CD for mobile app (future)
│       └── release.yaml        # Release workflow (tag-triggered builds)
├── mobile/                     # Future: React Native mobile app
│   └── (to be structured in future phase)
├── docs/
│   ├── development.md          # Development guide (local setup, build, test)
│   ├── deployment.md           # Deployment guide (package installation, configuration)
│   ├── api.md                  # API documentation (generated from OpenAPI spec)
│   └── security.md             # Security considerations and best practices
├── go.mod                      # Go module definition
├── go.sum                      # Go module checksums
├── .golangci.yml               # golangci-lint configuration (includes gosec, govulncheck)
├── .gitignore                  # Git ignore file (includes _output/ and other build artifacts)
├── LICENSE                     # MIT or Apache 2.0 license
└── README.md                   # Project overview and quickstart
```

**Structure Decision**: Multi-component project with primary focus on the Go service (`cmd/boardingpass/`). The `internal/` directory follows Go best practices for private packages. The `pkg/protocol/` directory contains shared types for future mobile app integration. The `mobile/` directory is reserved for the React Native app in a future phase. Build scripts, packaging templates, and example password generator script are isolated in `build/` and CI/CD configurations in `.github/workflows/`. **All build artifacts** (binaries, packages, coverage reports) are segregated into the `_output/` directory which is gitignored to keep the repository clean. GoReleaser is configured to output to `_output/dist/` and local builds output to `_output/bin/`.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**Status**: No violations identified. All constitution principles are satisfied by the current design.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A       | N/A        | N/A                                 |

**Notes**:
- All technical decisions finalized: FIPS 140-3 compliance drives use of Go stdlib crypto only
- Dynamic password generation via user-configurable script ensures device-unique credentials while maintaining single bootc image
- Password generator script can output serial number, TPM endorsement key, MAC address, or combination thereof
- GoReleaser selected for build/package orchestration to streamline CI/CD
- Security tooling consolidated into golangci-lint for single-pass analysis
- Logging simplified to stdout/stderr (systemd journal captures automatically)
- **Clarification Session 2025-12-06**: Added explicit requirements for:
  - Session token expiry: 30 minutes
  - Brute force protection: Progressive delays (1s, 2s, 5s, 60s lockout)
  - TLS certificates: Self-signed at first boot if not in OS image
  - Configuration path restrictions: Allow-list of permitted subdirectories
  - Provisioning completion: Explicit POST /complete endpoint (not automatic)